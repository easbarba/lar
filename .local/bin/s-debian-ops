#!/usr/bin/env bash

# Debug Options
set -euo pipefail

DEPS=(sudo apt curl python3 go systemctl tee gpasswd)
s-checkdeps "${DEPS[@]}"

INSTALL='sudo apt-get install -yqq'
UPDATE='sudo apt-get update'

[[ ! -x $(command -v ansible) ]] && {
    $INSTALL ansible
    python3 -m pip install cryptography # faster ansible vault encryption
}

[[ ! -x $(command -v aws) ]] && $INSTALL awscli

[[ ! -x $(command -v aws-iam-authenticator) ]] && {
    curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator -P "$HOME/.local/bin"
    chmod +x "$HOME/.local/bin/aws-iam-authenticator"
}

[[ ! -x $(command -v docker) ]] && {
    [[ ! -f /etc/apt/sources.list.d/docker.list ]] && {
        # uninstall old versions
        # sudo apt-get remove -y docker docker-engine docker.io containerd runc

        # allow apt to use a repository over HTTPS
        $INSTALL ca-certificates curl gnupg lsb-release

        # Add Dockerâ€™s official GPG key:
        curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

        # set up the stable repository
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bullseye stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
    }

    $UPDATE
    $INSTALL docker-ce docker-ce-cli containerd.io docker-compose

    sudo systemctl start docker
    sudo systemctl enable docker.service

    sudo groupadd docker
    sudo gpasswd -a "$USER" docker

    sudo systemctl restart docker

    # activate group, for now
    newgrp docker
}

[[ ! -x $(command -v eksctl) ]] && {
    curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
    sudo mv /tmp/eksctl /usr/local/bin
}

[[ ! -x $(command -v gcloud) ]] && {

    [[ -f /etc/apt/sources.list.d/google-cloud-sdk.list ]] && return

    $INSTALL apt-transport-https ca-certificates gnupg
    echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -

    $UPDATE && $INSTALL google-cloud-sdk
}

[[ ! -x $(command -v gitlab-runner) ]] && $INSTALL gitlab-runner
[[ ! -x $(command -v kind) ]] && GO111MODULE=on go install sigs.k8s.io/kind@v0.12.0

[[ ! -x $(command -v terraform) ]] && {
    [[ ! -f /etc/apt/sources.list.d/hashicorp.list ]] && {
        wget -qO- https://apt.releases.hashicorp.com/gpg | sudo tee /etc/apt/trusted.gpg.d/terraform.asc
        echo "deb [arch=$(dpkg --print-architecture)] https://apt.releases.hashicorp.com bullseye main" | sudo tee /etc/apt/sources.list.d/hashicorp.list >/dev/null
    }

    $UPDATE && $INSTALL vagrant vagrant-libvirt # terraform nomad
}

[[ ! -x $(command -v helm) ]] && {
    wget -qO- https://baltocdn.com/helm/signing.asc | sudo tee /etc/apt/trusted.gpg.d/heml.asc
    sudo apt-get install apt-transport-https --yes
    echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
    sudo apt-get update

    $INSTALL helm
}

[[ ! -x $(command -v minikube) ]] && {
    curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
    sudo apt install ./minikube_latest_amd64.deb
}

[[ ! -x $(command -v kubectl) ]] && {
    [[ ! -f /etc/apt/sources.list.d/kubernetes.list ]] && {
        $UPDATE
        $INSTALL apt-transport-https ca-certificates curl
        sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
        echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
    }

    $UPDATE && $INSTALL kubectl kubelet kubeadm
}

[[ ! -x $(command -v jenkins) ]] && {
    curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo tee \
        /usr/share/keyrings/jenkins-keyring.asc >/dev/null

    echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \
        https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
        /etc/apt/sources.list.d/jenkins.list >/dev/null

    $UPDATE && $INSTALL fontconfig openjdk-11-jre jenkins
}

[[ ! -x $(command -v qemu-img) ]] && $INSTALL qemu # infra=( qemu qemu-utils qemu-efi qemu-kvm ) # ebtables
[[ ! -x $(command -v virtualbox) ]] && $INSTALL virtualbox

[[ ! -x $(command -v virt-manager) ]] && {
    $INSTALL libvirt-daemon-system libvirt-clients libvirt-daemon-system virtinst bridge-utils virt-manager

    sudo systemctl start libvirtd
    sudo systemctl enable libvirtd

    sudo usermod -aG libvirt "$USER"
    sudo usermod -aG kvm "$USER"
}

[[ ! -x $(command -v podman) ]] && {
    $INSTALL podman

    sudo systemctl enable podman.socket
    sudo systemctl start podman.socket

    # Add a new group called podman so its easier to manage who can run podman w/out sudo
    echo '%podman ALL=(ALL) NOPASSWD: /usr/bin/podman' | sudo tee -a /etc/sudoers.d/podman
}

[[ ! -x $(command -v podman-compose) ]] && {
    python3 -m pip install podman-compose --upgrade

    # Docker Compose will use the correct socket.
    export DOCKER_HOST=///run/user/$UID/podman/podman.sock
}

[[ ! -x $(command -v gnutls-cli) ]] && $INSTALL gnutls-bin

[[ ! -x $(command -v tcpdump) ]] && {
    packages=(net-tools iproute2 telnet dnsutils iwd iw wireless-tools
        resolvconf dhcpcd5 netcat-traditional tcpdump)

    s-dolist $INSTALL "${packages[@]}"
}

[[ ! -x $(command -v firewalld) ]] && {
    $INSTALL firewalld

    sudo systemctl enable firewalld
    sudo systemctl start firewalld
}
