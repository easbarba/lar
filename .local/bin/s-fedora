#!/usr/bin/env bash

# Debug Options
set -euo pipefail

DEPS=(sudo dnf wget systemctl fc-cache)
s-checkdeps "${DEPS[@]}"

s-echo "Fedora"

upgrade() {
	s-echo "Upgrading System"

	sudo dnf update -y
	sudo dnf upgrade -y
}

pre() {
	multi() {
		s-echo "Enable Multi-Arch"

	}

	# * RUN
	multi
}

packages() {
	s-echo "Installing system packages"

	essentials=(git openssh curl unzip bash tmux zile lynx)

	system=(zip p7zip recutils lshw at usbutils lsof atool perf time entr tree
		bc htop strace ltrace cpio lzop libnotify jq rsync pv texinfo unrar nscd
		autoconf automake socat)

	network=(net-tools iproute telnet)

	programming=(gawk git-email subversion mercurial direnv libpq editorconfig)

	shell=(bash-completion ShellCheck zsh fish)

	editors=(emacs vim neovim micro)

	gnu=(gcc make info wget parallel)

	languages=(python3-pip ruby-devel golang guile30 npm nodejs)

	infra=(podman podman-compose vagrant qemu)

	laptop=(acpi lm_sensors)

	gnome=(gnome-tweaks gnome-shell-extension-auto-move-windows gnome-shell-extension-launch-new-instance)

	wmapps=(ffmpeg mpv elinks wl-clipboard)

	books=(pandoc) #  texlive texlive-xetex

	user=(exaile gimp obs-studio xdg-utils ImageMagick aspell vlc
		aspell-pt_BR telegram-desktop calibre gaupol)

	media=(vorbis-tools gstreamer1-plugins-bad-free gstreamer1-plugins-base
		gstreamer1-plugins-good gstreamer1-plugins-ugly)

	local command='sudo dnf install -y'

	enabled=(
		"${essentials[@]}"
		"${system[@]}"
		"${gnu[@]}"
		"${network[@]}"
		"${shell[@]}"
		"${fedora[@]}"
		"${languages[@]}"
		"${programming[@]}"
		"${editors[@]}"
		"${gnome[@]}"
		"${infra[@]}"
		"${laptop[@]}"
		"${wmapps[@]}"
		"${books[@]}"
		"${user[@]}"
		"${media[@]}")

	for i in "${enabled[@]}"; do
		s-dolist "$command" "$i"
	done

	s-echo "Done"
}

clean() {
	s-echo "Clean up"

	unused=(firefox-esr)

	local command='sudo dnf remove -y'
	s-dolist "$command" "${unused[@]}"

	purging=(*nvidia*)
	local command='sudo dnf purge -y'
	s-dolist "$command" "${purging[@]}"
}

services() {
	s-echo "System Services"

	_podman() {
		sudo systemctl enable podman.socket
		sudo systemctl start podman.socket
		sudo systemctl status podman.socket
	}

	_kdeconnect() {
		sudo firewall-cmd --zone=public --permanent --add-port=1714-1764/tcp
		sudo firewall-cmd --zone=public --permanent --add-port=1714-1764/udp
		sudo systemctl restart firewalld.service
	}

}

_virtualization() {
	sudo dnf install @virtualization

	_libvirt() {
		# service
		sudo systemctl start libvirtd
		sudo systemctl enable libvirtd

		# user
		sudo usermod -aG libvirt "$USER"
		sudo usermod -aG kvm "$USER"
	}
}

_podman() {
	_group() {
		# add a new group called podman so its easier to manage who can run podman w/out sudo

		# 		sudo cat <<eof >/etc/sudoers.d/podman
		# %podman ALL=(ALL) NOPASSWD: /usr/bin/podman
		# eof
	}

}

foreign() {
	echo "Foreign packages"

	_rpmfusion() {
		[[ $(grep -rni 'rpmfusion-free' /etc/yum.repos.d) ]] && return

		sudo dnf install "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm" \
			"https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm"
	}

	_virtualbox() {
		[[ -x $(command -v virtualbox) ]] && return

		sudo dnf install -y VirtualBox
	}

	_docker() {
		[[ -x $(command -v virtualbox) ]] && return

		sudo dnf -y install dnf-plugins-core
		sudo dnf install docker-ce docker-ce-cli containerd.io

		sudo systemctl start docker
		sudo systemctl enable docker.service

		sudo groupadd docker && sudo gpasswd -a ${USER} docker && sudo systemctl restart docker
	}

	_podman_docker_compose() {
		# Docker Compose will use the correct socket.
		export DOCKER_HOST=///run/user/$UID/podman/podman.sock
	}

	_vscode() {
		[[ -x $(command -v code) ]] && return

		sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
		sudo sh -c 'echo -e "[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/vscode.repo'

		sudo dnf install -y code
	}

	_aws() {
		[[ -x $(command -v aws) ]] && return

		sudo dnf install -y awscli
	}

	_terraform() {
		[[ -x $(command -v terraform) ]] && return

		sudo dnf config-manager --add-repo https://rpm.releases.hashicorp.com/fedora/hashicorp.repo
		sudo dnf install -y terraform
	}

	_rust() {
		[[ -x $HOME/.cargo/bin/cargo ]] && return

		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
	}

	_gitlab() {
		[[ ! -f /tmp/gitlab-runner_amd64.rpm ]] &&
			wget -c https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_amd64.rpm -P /tmp

		sudo dnf install /tmp/gitlab-runner_amd64.rpm
	}

	_gitlab
	_rust
	_rpmfusion
	_virtualbox
	_aws
	_terraform
	_vscode
}

_k8s() {
	_minikube() {
		curl -Lo /tmp/minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
		chmod +x /tmp/minikube
		sudo mv /tmp/minikube /usr/local/bin/
	}

	_kubectl() {
		curl -o /tmp/kubectl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"

		chmod +x /tmp/kubectl
		sudo mv /tmp/kubectl /usr/local/bin/
	}

	_minikube
}

# * RUN

upgrade
packages
foreign
# pre
# clean
#services
