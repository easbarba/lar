#!/usr/bin/env bash

# Debug Options
set -euo pipefail

EMAIL="$USER@tutanota.com"
SSH_HOME="$HOME/.ssh"
SSH_KEY_LOCATION="$SSH_HOME/id_ed25519"

# Generate new key
[[ ! -f $SSH_KEY_LOCATION ]] && ssh-keygen -t ed25519 -C "$EMAIL"

# start agent
eval "$(ssh-agent -s)"

# add private key auth to agent
ssh-add "$SSH_KEY_LOCATION"

[[ ! -f "$SSH_HOME/config" ]] && cat <<EOF >>"$SSH_HOME/config"
Host *
     AddKeysToAgent yes
     IdentityFile $SSH_KEY_LOCATION
EOF

# Protect files
chmod 700 "$SSH_HOME"
chmod 600 "$SSH_KEY_LOCATION"
chmod 600 "${SSH_KEY_LOCATION}.pub"
chmod 600 "$SSH_HOME/known_hosts"

# New Global defaults
# sudo sed -i "s/Port 22|Port 33/g" # new port
# sudo sed -i "PermitRootLogin no"  # Disable root
# sudo sed -i "AllowUsers username" # limit users acess
# sudo sed -i "Protocol 2"          # use protocol 2
