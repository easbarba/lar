#!/usr/bin/env bash

# Debug Options
set -euo pipefail

DEPS=(apt-get bash)
s-checkdeps "${DEPS[@]}"

COMMAND='sudo apt-get install -y'

mx=(emacs libgccjit0 libgccjit-12-dev libwebkit2gtk-4.0-dev libjansson-dev libjansson4)
s-dolist "$COMMAND" "${mx[@]}"

# langs
packages=(ruby-full ruby-dev clang clangd clang-format glslang-tools nodejs npm
    golang python3-pip libssl-dev libfixposix-dev libzstd-dev guile-3.0)
s-dolist "$COMMAND" "${packages[@]}"

if [[ ! -x $(command -v dart) ]]; then
    sudo apt update
    sudo apt install -y apt-transport-https
    curl -fsSL https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/dart.gpg
    echo 'deb [signed-by=/usr/share/keyrings/dart.gpg arch=amd64] https://storage.googleapis.com/download.dartlang.org/linux/debian stable main' | sudo tee /etc/apt/sources.list.d/dart_stable.lis

    sudo apt update
    sudo apt install -y dart
fi

# editors
packages=(zile vim neovim tidy ripgrep)
s-dolist "$COMMAND" "${packages[@]}"

# programming
packages=(jq git-email subversion mercurial libpq-dev editorconfig gnome-keyring direnv fd-find)
s-dolist "$COMMAND" "${packages[@]}"

# postgres
packages=(postgresql postgresql-contrib postgresql-doc)
s-dolist "$COMMAND" "${packages[@]}"
sudo systemctl restart postgresql

HBA_CONF='/etc/postgresql/*/main/pg_hba.conf' # psql --version | awk '{print substr($3, 0, 2)}'
if ! sudo grep -i "$USER" "$HBA_CONF"; then
    sudo -u postgres createuser -e "$USER" --pwprompt
    echo -n "local  all  $USER  md5" | sudo tee -a "$HBA_CONF"
    sudo systemctl restart postgresql
fi

exit
