#!/usr/bin/env bash

# set -e

# * ASDF

asdf_install()
{
    local asdf_dir="$HOME/.asdf"

    if [[ ! -d $asdf_dir ]]; then
	git clone https://github.com/asdf-vm/asdf.git "$asdf_dir"

	cd "$asdf_dir" && git checkout "$(git describe --abbrev=0 --tags)"
    fi
}

asdf_activate()
{
    source "$HOME"/.asdf/completions/asdf.bash
    source "$HOME"/.asdf/asdf.sh

    local asdf_shims_dir="$HOME"/.asdf/shims
    [[ -d $asdf_shims_dir ]] && return

    export PATH="$asdf_shims_dir"${PATH:+:}$PATH
}

asdf()
{
    echo 'Installing asdf'

    # https://asdf-vm.com/#/core-manage-asdf
    # https://asdf-vm.com/#/core-manage-plugins
    # https://asdf-vm.com/#/core-commands
    # https://asdf-vm.com/#/plugins-all

    asdf_install
    asdf_activate

    asdf update
}

asdf_golang()
{
    echo 'Installing golang binaries'

    # https://github.com/kennyp/asdf_golang

    asdf plugin-add golang https://github.com/kennyp/asdf_golang.git

    asdf install golang latest

    asdf global golang "$(asdf latest golang)"
}

asdf_all()
{
    echo 'Installing asdf backends'

    asdf
    asdf_golang
}

# * PACKAGES

golang()
{
    echo 'Installing golang packages'

    export GO111MODULE=on

    local packages=("golang.org/x/tools/gopls@latest" "sigs.k8s.io/kind")

    for pack in "${packages[@]}"
    do
	go get -u "${pack}"
    done
}

all()
{
    echo 'Installing language package manager packages'

    golang
}

# * RUN

asdf_all
all
