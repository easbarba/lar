#!/usr/bin/env bash

# Debug Options
set -euxo pipefail

BUILDS="$HOME/Builds"
EMACS_DIR="$BUILDS/emacs"
PREFIX="$HOME/.local"
TAG=emacs-27.1

check_deps()
{
    [[ ! -x $(command -v git) ]] && exit
}

repo_get()
{
    [[ -d $EMACS_DIR ]] && return

    git clone "https://git.savannah.gnu.org/git/emacs" "$BUILDS/emacs"
}

repo_update()
{
    [[ -d "$EMACS_DIR/.git" ]] && git pull
}

repo_checkout()
{
    git checkout ${TAG}
}

install()
{
    cd "$EMACS_DIR" || return

    make distclean

    sh autogen.sh

    sh configure --prefix="$PREFIX" --with-modules --with-gif --with-jpeg --with-png --with-rsvg --with-tiff --with-xft --with-xpm --with-x --with-dbus --with-imagemagick --with-mailutils --with-gnutls --with-x-toolkit=gtk3

    make -j2

    make install
}

# * RUN

echo "Emacs - Installing local build"

check_deps

repo_get
repo_update
repo_checkout

install
